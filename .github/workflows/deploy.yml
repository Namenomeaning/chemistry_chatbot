name: Deploy to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/key.pem
          chmod 600 ~/.ssh/key.pem

      - name: Deploy
        id: deploy
        run: |
          ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/chemistry_chatbot

            # Save current commit for rollback
            git rev-parse HEAD > /tmp/prev_commit

            # Pull and rebuild
            git pull origin main
            docker compose up -d --build

            # Health check (wait 30s, try 3 times)
            sleep 30
            for i in 1 2 3; do
              curl -sf http://localhost/health && exit 0
              sleep 10
            done
            exit 1
          EOF

      - name: Rollback on failure
        if: failure()
        run: |
          ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/chemistry_chatbot
            git reset --hard $(cat /tmp/prev_commit)
            docker compose up -d --build
            echo "Rolled back to $(cat /tmp/prev_commit)"
          EOF
