<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHEMI - Tr·ª£ l√Ω H√≥a h·ªçc</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Be Vietnam Pro', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        chemistry: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        /* Animated gradient background */
        .bg-animated {
            background: linear-gradient(-45deg, #0f172a, #1e293b, #0f172a, #1e3a2f);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Floating molecules decoration */
        .molecule {
            position: absolute;
            opacity: 0.03;
            font-size: 60px;
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }

        /* Glass effect */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Message animation */
        .message-enter {
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Typing indicator */
        .typing-dot {
            animation: typingBounce 1.4s ease-in-out infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* Button hover effect */
        .btn-glow:hover {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }

        /* Input focus ring */
        .input-ring:focus-within {
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }

        /* Smooth transitions */
        * {
            transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        /* Hide scrollbar but keep functionality */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Audio player custom style */
        audio {
            height: 36px;
            border-radius: 8px;
        }

        audio::-webkit-media-controls-panel {
            background: #1e293b;
        }
    </style>
</head>
<body class="bg-animated font-sans text-gray-100 h-screen overflow-hidden">
    <!-- Decorative molecules -->
    <div class="molecule" style="top: 10%; left: 5%;">‚öóÔ∏è</div>
    <div class="molecule" style="top: 30%; right: 10%; animation-delay: -5s;">üß™</div>
    <div class="molecule" style="bottom: 20%; left: 15%; animation-delay: -10s;">‚öõÔ∏è</div>
    <div class="molecule" style="bottom: 40%; right: 5%; animation-delay: -7s;">üî¨</div>

    <div class="flex h-full relative z-10">
        <!-- Sidebar -->
        <aside class="w-64 glass flex flex-col border-r border-gray-700/50 hidden md:flex">
            <!-- New Chat Button -->
            <div class="p-3">
                <button onclick="startNewChat()"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl border border-gray-600/50 hover:bg-gray-700/50 text-sm font-medium">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Cu·ªôc tr√≤ chuy·ªán m·ªõi
                </button>
            </div>

            <!-- Logo -->
            <div class="flex items-center gap-3 px-4 py-4 border-b border-gray-700/30">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-chemistry-500 to-emerald-400 flex items-center justify-center text-xl shadow-lg">
                    ‚öóÔ∏è
                </div>
                <div>
                    <div class="font-bold text-lg">CHEMI</div>
                    <div class="text-xs text-gray-400">Tr·ª£ l√Ω H√≥a h·ªçc THPT</div>
                </div>
            </div>

            <!-- Chat History -->
            <div id="chatHistory" class="flex-1 overflow-y-auto hide-scrollbar p-2 space-y-1">
                <!-- History items here -->
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-gray-700/30 text-center text-xs text-gray-500">
                CHEMI v2.0
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0">
            <!-- Header -->
            <header class="glass border-b border-gray-700/30 px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-2 text-sm font-medium">
                    <div class="w-2 h-2 rounded-full bg-chemistry-500 animate-pulse"></div>
                    CHEMI Online
                </div>
                <div class="text-xs text-gray-500">
                    Session: <span id="sessionId" class="text-gray-400">--</span>
                </div>
            </header>

            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="flex-1 flex flex-col items-center justify-center p-6">
                <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-chemistry-500 to-emerald-400 flex items-center justify-center text-4xl mb-6 shadow-xl shadow-chemistry-500/20">
                    ‚öóÔ∏è
                </div>
                <h1 class="text-3xl font-bold mb-2">Xin ch√†o!</h1>
                <p class="text-gray-400 mb-8">T√¥i l√† CHEMI - Tr·ª£ l√Ω H√≥a h·ªçc cho h·ªçc sinh THPT</p>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-w-xl w-full">
                    <button onclick="sendExample('Ethanol l√† g√¨?')"
                        class="glass rounded-xl p-4 text-left hover:bg-gray-700/50 group">
                        <div class="text-2xl mb-2">üß™</div>
                        <div class="text-sm text-gray-300 group-hover:text-white">"Ethanol l√† g√¨?"</div>
                        <div class="text-xs text-gray-500 mt-1">T√¨m hi·ªÉu v·ªÅ r∆∞·ª£u etylic</div>
                    </button>
                    <button onclick="sendExample('C2H4 c√≥ t√™n g·ªçi l√† g√¨?')"
                        class="glass rounded-xl p-4 text-left hover:bg-gray-700/50 group">
                        <div class="text-2xl mb-2">üî¨</div>
                        <div class="text-sm text-gray-300 group-hover:text-white">"C2H4 c√≥ t√™n g·ªçi l√† g√¨?"</div>
                        <div class="text-xs text-gray-500 mt-1">Tra c·ª©u t·ª´ c√¥ng th·ª©c</div>
                    </button>
                    <button onclick="sendExample('Axit acetic c√≥ c√¥ng th·ª©c nh∆∞ th·∫ø n√†o?')"
                        class="glass rounded-xl p-4 text-left hover:bg-gray-700/50 group">
                        <div class="text-2xl mb-2">üìù</div>
                        <div class="text-sm text-gray-300 group-hover:text-white">"Axit acetic c√≥ c√¥ng th·ª©c?"</div>
                        <div class="text-xs text-gray-500 mt-1">H·ªçc v·ªÅ axit h·ªØu c∆°</div>
                    </button>
                    <button onclick="document.getElementById('imageInput').click()"
                        class="glass rounded-xl p-4 text-left hover:bg-gray-700/50 group">
                        <div class="text-2xl mb-2">üì∑</div>
                        <div class="text-sm text-gray-300 group-hover:text-white">T·∫£i ·∫£nh c√¥ng th·ª©c</div>
                        <div class="text-xs text-gray-500 mt-1">Nh·∫≠n di·ªán t·ª´ h√¨nh ·∫£nh</div>
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 hidden">
                <!-- Messages here -->
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-gray-700/30">
                <div class="max-w-3xl mx-auto">
                    <!-- Image Preview -->
                    <div id="imagePreviewArea" class="mb-3 hidden">
                        <div class="inline-flex items-start gap-2 glass rounded-lg p-2">
                            <img id="previewThumb" src="" alt="Preview" class="w-16 h-16 object-cover rounded-lg">
                            <button onclick="removeImage()"
                                class="w-6 h-6 rounded-full bg-red-500/80 hover:bg-red-500 flex items-center justify-center text-xs">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Input Box -->
                    <div class="glass rounded-2xl p-2 flex items-end gap-2 input-ring">
                        <button onclick="document.getElementById('imageInput').click()"
                            class="w-10 h-10 rounded-xl hover:bg-gray-700/50 flex items-center justify-center text-gray-400 hover:text-white shrink-0">
                            <i data-lucide="image" class="w-5 h-5"></i>
                        </button>
                        <input type="file" id="imageInput" accept="image/*" onchange="handleImageSelect(event)" class="hidden">

                        <textarea id="textInput"
                            placeholder="H·ªèi v·ªÅ h·ª£p ch·∫•t h√≥a h·ªçc... (Ctrl+V ƒë·ªÉ d√°n ·∫£nh)"
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResize(this)"
                            class="flex-1 bg-transparent border-none outline-none resize-none text-sm py-2.5 placeholder-gray-500 max-h-32"></textarea>

                        <button id="sendBtn" onclick="sendMessage()"
                            class="w-10 h-10 rounded-xl bg-chemistry-600 hover:bg-chemistry-500 flex items-center justify-center shrink-0 btn-glow disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <p class="text-center text-xs text-gray-600 mt-3">
                        CHEMI c√≥ th·ªÉ m·∫Øc l·ªói. H√£y ki·ªÉm tra th√¥ng tin quan tr·ªçng.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // State
        let threadId = null;
        let selectedImage = null;
        let selectedImageBase64 = null;
        let isLoading = false;
        let chatHistory = [];
        let allSessions = []; // All saved sessions

        const API_BASE = window.location.origin;

        // Storage config
        const STORAGE_CONFIG = {
            maxSessions: 10,        // Max sessions to keep
            maxMessagesPerSession: 50,  // Max messages per session
            maxStorageSize: 4 * 1024 * 1024, // 4MB limit
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSession();
            updateSessionDisplay();
            setupPasteHandler();
        });

        // Paste handler
        function setupPasteHandler() {
            document.addEventListener('paste', handlePaste);
        }

        function handlePaste(event) {
            const items = event.clipboardData?.items;
            if (!items) return;
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    event.preventDefault();
                    const file = item.getAsFile();
                    if (file) processImageFile(file);
                    break;
                }
            }
        }

        function processImageFile(file) {
            selectedImage = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedImageBase64 = e.target.result.split(',')[1];
                document.getElementById('previewThumb').src = e.target.result;
                document.getElementById('imagePreviewArea').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        // Session Management
        function loadSession() {
            try {
                // Load all sessions
                const savedSessions = localStorage.getItem('chemi_sessions');
                if (savedSessions) {
                    allSessions = JSON.parse(savedSessions);
                }

                // Load current session
                const currentId = localStorage.getItem('chemi_current_session');
                if (currentId) {
                    const session = allSessions.find(s => s.threadId === currentId);
                    if (session) {
                        threadId = session.threadId;
                        chatHistory = session.messages || [];
                        if (chatHistory.length > 0) {
                            renderChatHistory();
                            showMessages();
                        }
                    }
                }

                renderSessionList();
            } catch (e) {
                console.error('Error loading session:', e);
                cleanupStorage();
            }
        }

        function saveSession() {
            if (!threadId || chatHistory.length === 0) return;

            try {
                // Prepare messages for storage (strip media for old messages)
                const messagesForStorage = chatHistory.map((msg, idx) => {
                    // Keep media only for last 5 messages
                    const isRecent = idx >= chatHistory.length - 5;
                    return {
                        role: msg.role,
                        text: msg.text,
                        error: msg.error,
                        // Only keep media references, not full base64 for older messages
                        hasImage: !!msg.userImage || !!msg.structureImage,
                        hasAudio: !!msg.audio,
                        // Keep actual media only for recent messages
                        userImage: isRecent ? msg.userImage : null,
                        structureImage: isRecent ? msg.structureImage : null,
                        audio: isRecent ? msg.audio : null,
                        timestamp: msg.timestamp || Date.now()
                    };
                });

                // Find or create session
                const existingIdx = allSessions.findIndex(s => s.threadId === threadId);
                const sessionData = {
                    threadId,
                    title: chatHistory[0]?.text?.slice(0, 30) || 'Cu·ªôc tr√≤ chuy·ªán',
                    messages: messagesForStorage.slice(-STORAGE_CONFIG.maxMessagesPerSession),
                    updatedAt: Date.now()
                };

                if (existingIdx >= 0) {
                    allSessions[existingIdx] = sessionData;
                } else {
                    allSessions.unshift(sessionData);
                }

                // Sort by most recent
                allSessions.sort((a, b) => b.updatedAt - a.updatedAt);

                // Cleanup if needed
                cleanupStorage();

                // Save
                localStorage.setItem('chemi_sessions', JSON.stringify(allSessions));
                localStorage.setItem('chemi_current_session', threadId);

                renderSessionList();
            } catch (e) {
                console.error('Error saving session:', e);
                if (e.name === 'QuotaExceededError') {
                    cleanupStorage(true);
                    saveSession(); // Retry
                }
            }
        }

        function cleanupStorage(aggressive = false) {
            // Remove excess sessions
            const maxSessions = aggressive ? 5 : STORAGE_CONFIG.maxSessions;
            if (allSessions.length > maxSessions) {
                allSessions = allSessions.slice(0, maxSessions);
            }

            // If aggressive, strip all media from non-current sessions
            if (aggressive) {
                allSessions = allSessions.map(session => ({
                    ...session,
                    messages: session.messages.map(msg => ({
                        ...msg,
                        userImage: null,
                        structureImage: null,
                        audio: null
                    }))
                }));
            }

            // Check storage size
            const dataSize = new Blob([JSON.stringify(allSessions)]).size;
            if (dataSize > STORAGE_CONFIG.maxStorageSize && !aggressive) {
                cleanupStorage(true);
            }
        }

        function startNewChat() {
            // Save current session first
            if (threadId && chatHistory.length > 0) {
                saveSession();
            }

            threadId = null;
            chatHistory = [];
            selectedImage = null;
            selectedImageBase64 = null;
            localStorage.removeItem('chemi_current_session');
            updateSessionDisplay();
            showWelcome();
            document.getElementById('chatMessages').innerHTML = '';
            document.getElementById('imagePreviewArea').classList.add('hidden');
            renderSessionList(); // Re-render to remove active state
        }

        function loadSessionById(id) {
            // Save current first
            if (threadId && chatHistory.length > 0) {
                saveSession();
            }

            const session = allSessions.find(s => s.threadId === id);
            if (session) {
                threadId = session.threadId;
                chatHistory = session.messages || [];
                localStorage.setItem('chemi_current_session', threadId);
                updateSessionDisplay();
                showMessages();
                renderChatHistory();
                renderSessionList();
            }
        }

        function deleteSession(id, event) {
            event.stopPropagation();
            allSessions = allSessions.filter(s => s.threadId !== id);
            localStorage.setItem('chemi_sessions', JSON.stringify(allSessions));

            if (threadId === id) {
                startNewChat();
            }
            renderSessionList();
        }

        function updateSessionDisplay() {
            document.getElementById('sessionId').textContent = threadId ? threadId.slice(-8) : 'M·ªõi';
        }

        function renderSessionList() {
            const historyDiv = document.getElementById('chatHistory');
            historyDiv.innerHTML = '';

            allSessions.forEach(session => {
                const item = document.createElement('div');
                const isActive = session.threadId === threadId;
                item.className = `flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer group ${isActive ? 'bg-gray-700/50' : 'hover:bg-gray-700/30'} text-sm text-gray-300`;
                item.onclick = () => loadSessionById(session.threadId);

                const date = new Date(session.updatedAt);
                const timeStr = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });

                item.innerHTML = `
                    <i data-lucide="message-square" class="w-4 h-4 text-gray-500 shrink-0"></i>
                    <div class="flex-1 min-w-0">
                        <div class="truncate">${escapeHtml(session.title)}...</div>
                        <div class="text-xs text-gray-500">${timeStr}</div>
                    </div>
                    <button onclick="deleteSession('${session.threadId}', event)"
                        class="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-500/20 rounded text-gray-500 hover:text-red-400">
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                `;
                historyDiv.appendChild(item);
            });

            lucide.createIcons();
        }

        // UI State
        function showWelcome() {
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('welcomeScreen').classList.add('flex');
            document.getElementById('chatMessages').classList.add('hidden');
        }

        function showMessages() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('welcomeScreen').classList.remove('flex');
            document.getElementById('chatMessages').classList.remove('hidden');
        }

        // Image handling
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) processImageFile(file);
        }

        function removeImage() {
            selectedImage = null;
            selectedImageBase64 = null;
            document.getElementById('imageInput').value = '';
            document.getElementById('imagePreviewArea').classList.add('hidden');
        }

        // Input handling
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px';
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function sendExample(text) {
            document.getElementById('textInput').value = text;
            sendMessage();
        }

        // Send message
        async function sendMessage() {
            const textInput = document.getElementById('textInput');
            const text = textInput.value.trim();

            if (!text && !selectedImageBase64) return;
            if (isLoading) return;

            isLoading = true;
            showMessages();

            addMessage('user', text, selectedImageBase64 ? `data:image/png;base64,${selectedImageBase64}` : null);

            textInput.value = '';
            textInput.style.height = 'auto';
            const imageBase64ToSend = selectedImageBase64;
            removeImage();

            const loadingId = addLoadingMessage();
            document.getElementById('sendBtn').disabled = true;

            try {
                const response = await fetch(`${API_BASE}/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text || null,
                        image_base64: imageBase64ToSend || null,
                        thread_id: threadId
                    })
                });

                const data = await response.json();
                removeLoadingMessage(loadingId);

                if (data.success) {
                    threadId = data.thread_id;
                    updateSessionDisplay();
                    saveSession();
                    addMessage('bot', data.text_response, null, data.image_base64, data.audio_base64);
                } else {
                    addMessage('bot', null, null, null, null, data.error || 'C√≥ l·ªói x·∫£y ra.');
                }
            } catch (error) {
                removeLoadingMessage(loadingId);
                addMessage('bot', null, null, null, null, 'Kh√¥ng th·ªÉ k·∫øt n·ªëi server.');
            }

            isLoading = false;
            document.getElementById('sendBtn').disabled = false;
        }

        // Message rendering
        function addMessage(role, text, userImage = null, structureImage = null, audio = null, error = null) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-enter flex gap-3 ${role === 'user' ? 'justify-end' : ''}`;

            let content = '';

            if (role === 'user') {
                content = `
                    <div class="max-w-xl">
                        <div class="bg-chemistry-600/80 rounded-2xl rounded-br-md px-4 py-3 text-sm">
                            ${escapeHtml(text)}
                        </div>
                        ${userImage ? `<img src="${userImage}" class="mt-2 max-w-xs rounded-xl" alt="Uploaded">` : ''}
                    </div>
                `;
            } else {
                if (error) {
                    content = `
                        <div class="w-8 h-8 rounded-lg bg-red-500/20 flex items-center justify-center shrink-0 text-red-400">
                            <i data-lucide="alert-circle" class="w-4 h-4"></i>
                        </div>
                        <div class="glass rounded-2xl rounded-bl-md px-4 py-3 max-w-xl">
                            <p class="text-sm text-red-400">${escapeHtml(error)}</p>
                        </div>
                    `;
                } else {
                    let mediaHtml = '';
                    if (structureImage) {
                        const imgSrc = structureImage.startsWith('http') ? structureImage : `data:image/png;base64,${structureImage}`;
                        mediaHtml += `
                            <div class="mt-3 bg-white rounded-xl p-3 inline-block">
                                <img src="${imgSrc}" alt="C·∫•u tr√∫c" class="max-w-xs">
                                <p class="text-xs text-gray-500 mt-2 text-center">C·∫•u tr√∫c ph√¢n t·ª≠</p>
                            </div>
                        `;
                    }
                    if (audio) {
                        const audioSrc = audio.startsWith('http') ? audio : `data:audio/wav;base64,${audio}`;
                        mediaHtml += `
                            <div class="mt-3 glass rounded-xl p-3 max-w-xs">
                                <p class="text-xs text-gray-400 mb-2 flex items-center gap-1">
                                    <i data-lucide="volume-2" class="w-3 h-3"></i> Ph√°t √¢m
                                </p>
                                <audio controls class="w-full">
                                    <source src="${audioSrc}" type="audio/wav">
                                </audio>
                            </div>
                        `;
                    }

                    content = `
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-chemistry-500 to-emerald-400 flex items-center justify-center shrink-0 text-sm">
                            ‚öóÔ∏è
                        </div>
                        <div class="max-w-xl">
                            <div class="glass rounded-2xl rounded-bl-md px-4 py-3">
                                <div class="text-sm leading-relaxed prose-invert">${formatMarkdown(text || '')}</div>
                            </div>
                            ${mediaHtml}
                        </div>
                    `;
                }
            }

            messageDiv.innerHTML = content;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Reinitialize icons for new content
            lucide.createIcons();

            chatHistory.push({ role, text, userImage, structureImage, audio, error });
            saveSession();
        }

        function addLoadingMessage() {
            const messagesDiv = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message-enter flex gap-3';
            loadingDiv.innerHTML = `
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-chemistry-500 to-emerald-400 flex items-center justify-center shrink-0 text-sm">
                    ‚öóÔ∏è
                </div>
                <div class="glass rounded-2xl rounded-bl-md px-4 py-3">
                    <div class="flex gap-1">
                        <span class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></span>
                        <span class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></span>
                        <span class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></span>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return loadingId;
        }

        function removeLoadingMessage(id) {
            document.getElementById(id)?.remove();
        }

        function renderChatHistory() {
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = '';

            chatHistory.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex gap-3 ${msg.role === 'user' ? 'justify-end' : ''}`;

                let content = '';
                if (msg.role === 'user') {
                    // Show placeholder if image was cleaned up
                    let imageHtml = '';
                    if (msg.userImage) {
                        imageHtml = `<img src="${msg.userImage}" class="mt-2 max-w-xs rounded-xl" alt="Uploaded">`;
                    } else if (msg.hasImage) {
                        imageHtml = `<div class="mt-2 text-xs text-gray-500 italic flex items-center gap-1">
                            <i data-lucide="image" class="w-3 h-3"></i> H√¨nh ·∫£nh ƒë√£ ƒë∆∞·ª£c d·ªçn d·∫πp
                        </div>`;
                    }

                    content = `
                        <div class="max-w-xl">
                            <div class="bg-chemistry-600/80 rounded-2xl rounded-br-md px-4 py-3 text-sm">
                                ${escapeHtml(msg.text)}
                            </div>
                            ${imageHtml}
                        </div>
                    `;
                } else {
                    if (msg.error) {
                        content = `
                            <div class="w-8 h-8 rounded-lg bg-red-500/20 flex items-center justify-center shrink-0 text-red-400">!</div>
                            <div class="glass rounded-2xl rounded-bl-md px-4 py-3 max-w-xl">
                                <p class="text-sm text-red-400">${escapeHtml(msg.error)}</p>
                            </div>
                        `;
                    } else {
                        let mediaHtml = '';

                        // Structure image
                        if (msg.structureImage) {
                            const imgSrc = msg.structureImage.startsWith('http') ? msg.structureImage : `data:image/png;base64,${msg.structureImage}`;
                            mediaHtml += `<div class="mt-3 bg-white rounded-xl p-3 inline-block"><img src="${imgSrc}" alt="H√¨nh ·∫£nh" class="max-w-xs"></div>`;
                        } else if (msg.hasImage) {
                            mediaHtml += `<div class="mt-3 glass rounded-xl p-3 text-xs text-gray-500 italic flex items-center gap-1">
                                <i data-lucide="image" class="w-3 h-3"></i> H√¨nh ·∫£nh c·∫•u tr√∫c ƒë√£ ƒë∆∞·ª£c d·ªçn d·∫πp
                            </div>`;
                        }

                        // Audio
                        if (msg.audio) {
                            const audioSrc = msg.audio.startsWith('http') ? msg.audio : `data:audio/wav;base64,${msg.audio}`;
                            mediaHtml += `<div class="mt-3 glass rounded-xl p-3 max-w-xs"><p class="text-xs text-gray-400 mb-2 flex items-center gap-1"><i data-lucide="volume-2" class="w-3 h-3"></i> Ph√°t √¢m</p><audio controls class="w-full"><source src="${audioSrc}" type="audio/wav"></audio></div>`;
                        } else if (msg.hasAudio) {
                            mediaHtml += `<div class="mt-3 glass rounded-xl p-3 text-xs text-gray-500 italic flex items-center gap-1">
                                <i data-lucide="volume-x" class="w-3 h-3"></i> Audio ƒë√£ ƒë∆∞·ª£c d·ªçn d·∫πp
                            </div>`;
                        }

                        content = `
                            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-chemistry-500 to-emerald-400 flex items-center justify-center shrink-0 text-sm">‚öóÔ∏è</div>
                            <div class="max-w-xl">
                                <div class="glass rounded-2xl rounded-bl-md px-4 py-3">
                                    <div class="text-sm leading-relaxed">${formatMarkdown(msg.text || '')}</div>
                                </div>
                                ${mediaHtml}
                            </div>
                        `;
                    }
                }

                messageDiv.innerHTML = content;
                messagesDiv.appendChild(messageDiv);
            });

            lucide.createIcons();
        }

        // Utilities
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMarkdown(text) {
            if (!text) return '';
            let html = escapeHtml(text);
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong class="text-chemistry-400">$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/`(.*?)`/g, '<code class="bg-gray-800 px-1.5 py-0.5 rounded text-xs">$1</code>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }
    </script>
</body>
</html>
